<!DOCTYPE HTML>
<html>
<head>
<style>
	html, body {
	  width:  100%;
	  height: 100%;
	  margin: 0;
	  overflow: hidden;
	}
</style>
<script type="text/javascript" src="math.js"></script>
<script type="text/javascript" src="canvas_engine.js"></script>
<script type="text/javascript">
var canvas;
var ctx;
var time = 0;
//=========================================================================================== Tu c√≥digo aqui

var cubosLista = []

var KEY_R = 82
var KEY_ARROW_DOWN		= 40
var KEY_ARROW_UP		= 38
var KEY_ARROW_LEFT		= 37
var KEY_ARROW_RIGHT		= 39
var KEY_SPACE			= 32

var pause = false
var gameOver = false

var score = 0;

var isSpacePressed = false
var isRightPressed = false
var isLeftPressed = false

function Player(_x, _y){

  var player = {
    x: _x,
    y: _y,
    scale: 1,
    vx: 0,
    vy: 0,
    speed: 150,
    speedJump: -220,
    releaseSpeedJump: -6,
    a: 500,
    face: 1,
    ground : false,
    crouch: false,


    update: function(){
      //console.log(this.vy)

      // this.vy = 0
      // this.a = 0

      // if (this.y + 32 < suelo.y){
      //   this.vy = 1 * this.speed
      // }else{
      //   this.ground = true
      // }

      if (this.y + 32 > suelo.y){
        this.y = (suelo.y - 32)
        this.vy = 0
        this.ground = true
      }

      

      if (IsKeyPressed(KEY_SPACE)){
        // console.log("KeyPressed")
        if (!isSpacePressed){
          isSpacePressed = true
          this.jump()
        }
      }else{
        isSpacePressed = false
        this.releaseJump()
      }

      // Velocity
      this.vy += this.a * elapsed_time

      // Position
     this.x += this.vx * elapsed_time
     this.y += this.vy * elapsed_time

      console.log(this.vy)
     
     
     //this.y = this.y + (this.vy * elapsed_time) + (0.5 * this.a * (elapsed_time*elapsed_time))
     
     // Collision
     this.collision()
    },
    
    jump:function(){
      if (this.ground){
        this.vy = this.speedJump
        this.ground = false
      }
    },

    releaseJump:function(){
      if (this.vy < -6){
        // this.vy = -10
        this.vy = -2
      }

    },

    draw: function(){
      DrawRectangle(this.x, this.y, 16, 32, 255, 0, 0, 1)
    },

    collision:function(){
    
    	for (var i = 0; i < cubosLista.length; i++){

    		//console.log("Player x: " + this.x + "\nCubo "+ i + " x: " + cubosLista[i].x)

    		var colx1 = (this.x + 16) > cubosLista[i].x
    		var colx2 = this.x < (cubosLista[i].x + 16)
    		var colx = colx1 && colx2

    		var coly1 = (this.y + 16) > cubosLista[i].y
    		var coly2 = this.y < (cubosLista[i].y + 16)
    		var coly = coly1 && coly2


        if(colx && coly){
          gameOver = true
        }
    	}
    }
  }
  return player 
}

console.log(screenWidth, screenHeight)

function Generador(){

  var generador = {
    x: screenWidth,
    y: screenHeight/2,

    generateCube: function(){
      cubosLista.push(new Cubo(this.x, this.y))
    },

    update: function(){
      var rand = Math.random()
      if (rand > 0.9){
        this.generateCube()
        //console.log("Cubo generado: " + cubosLista.length)
      }

    },
  }

  return generador

}

function Cubo(_x, _y){
  var cubo = {
    x: _x,
    y: _y,
    scale: 1,
    vx: 0,
    vy: 0,
    speed: -150,
   
    update: function(){
      this.x += this.speed * elapsed_time;
    },

    draw: function(){
      DrawRectangle(this.x, this.y, 16, 32, 0, 0, 0, 1)
    },
    
  }
  
  return cubo
}

function Suelo(_x, _y, _w, _h){
	var suelo = {
		x: _x,
		y: _y,
		w: _w,
		h: _h,

		draw: function(){
			DrawRectangle(this.x, this.y, this.w, this.h, 0, 0, 0, 1)
		}
	}
	return suelo
}

var suelo = new Suelo(0, screenHeight/2+32,screenWidth, 32)
var player = new Player(50, 250)
var generador = new Generador()

function Start()
{
	SetScreenSize(800, 600)
}

function Update()
{

	if (!pause){
  player.update()
  generador.update()

  cubosLista.forEach(cubo => {
    if (cubo.x + 32 < 0){
      cubosLista.shift()
      score += 1
    }
    cubo.update()
  });
  }

  if (gameOver){
    pause = true
    if (IsKeyPressed(KEY_R)){
      location.reload()
    }
  }

}

function Render()
{
  //Limpiar fondo
  DrawRectangle(0, 0, 800, 600, 200, 200, 200, 1)
  //Dibujar personaje
  player.draw()
  DrawCircle(player.x, player.y, 1, 0,0,0,1)

  cubosLista.forEach(cubo => {
    cubo.draw()
  });

  suelo.draw()

  if (gameOver){
  	SetFont("45px Arial")
    DrawText("Game Over", 800/2 - 120, 200, 0, 0, 0, 1)
    DrawText("Press R to Restart", 800/2 - 200, 250, 0, 0, 0, 1)
  } 

}

//===========================================================================================
</script>
</head>
<body onload="Initialize();">
	<canvas id="mycanvas" width="1200" height="800"></canvas>
</body>
</html>
 
